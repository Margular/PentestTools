#!/usr/bin/env python3

import pymysql

host = 'localhost'
username = 'root'
password = 'root'
schema_name = 'aipai'
charset = 'utf8'
table_names = [ 'aipai1' ]
keys = ('username', 'password', 'email')    #定义应该加key的列

conn = pymysql.connect(host, username, password, schema_name, charset = charset)


for table_name in table_names:
    print("当前表: " + table_name)
    # 获取列名
    cur = conn.cursor()
    cur.execute("SELECT column_name FROM information_schema.columns WHERE table_schema = '{}' and table_name='{}';".format(schema_name, table_name))
    column_names = []
    for each in cur:
        column_names.append(each[0])
    # 获得已经加KEY的列名
    cur.execute("SHOW CREATE TABLE {};".format(table_name))
    for each in cur:
        for column_name in column_names:
            if each[1].find("KEY `{}`".format(column_name)) >= 0:
                column_names.remove(column_name)
    # 计算应该加KEY的列名
    column_names = list(set(column_names) & set(keys))
    if column_names is None:
        print('无需添加key')
        continue
    # 开始加列名
    sql = "ALTER TABLE " + table_name + " "
    for column_name in column_names:
        sql += "ADD KEY `{}` (`{}`),".format(column_name, column_name)
    sql = sql[:-1]  #去掉结尾的逗号
    cur.execute(sql)
    cur.close()
