<?php
	ini_set('display_errors', 'On');
	error_reporting(E_ALL & !E_NOTICE);

	const HOST = "localhost";
	const USERNAME = "root";	//数据库用户名
	const PASSWORD = "root";	//数据库密码
	
	$quest = strip_tags(trim($_GET['quest']));
	$databases = array();
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN">
<head>
<title>The Web of Answers</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="html/default.css" />
	<style type="text/css">
		body,td,th 
		{
			color: #FFF;
		}
		a:link 
		{
			color: #0C0;
			text-decoration: none;
		}
		body 
		{
			background-color: #000;
		}
		a:visited 
		{
			text-decoration: none;
			color: #999;
		}
		a:hover 
		{
			text-decoration: none;
		}
		a:active 
		{
			text-decoration: none;
			color: #F00;
		}
		.pages
		{
			clear: both;
			text-align: right;
			padding: 8px 0;
		}
		.pages a
		{
			display: inline-block;
			height: 20px;
			line-height: 20px;
			border: 1px solid #228B22;
			padding: 0 8px;
			color: #228B22;
			margin: 5px 2px;
			background: #2F2F2F;
		}
		.pages a:hover
		{
			background: #228B22;
			color: white;
		}
		.pages span 
		{
			display: inline-block;
			height: 20px;
			line-height: 20px;
			border: 1px solid #228B22;
			padding: 0 8px;
			margin: 5px 2px;
			background: #228B22; /*#228B22;*/
			color: white;	
		}
		#create_form label
		{
			margin-left: 10px;
		}
		#create_form em
		{
			margin-left: 60px;
		}
    </style>
<script>
<!--
	function check(form)
	{
		if(form.quest.value=="")
		{
			alert("不能为空值！");
			form.quest.focus();
			return false;
		}
	}
-->
</script>
</head>

<body>
	<div id="container">
		<div id="header"><h1>The Web of Answers</h1></div><br /><br />
		
		<div id="content">
			<form name="form" method="GET">
				<div id="create_form">
					<p><em></em>
						<label for=""><input type="checkbox" name="full" value="1" <?php echo !empty($_GET['full']) ? 'checked' : '';?> />完整匹配</label>
					</p>
					<p style="text-align:center;margin:0 auto;">
						<label><input class="inurl" size="26" id="unurl" name="quest" value="<?php echo strip_tags(trim($_GET['quest']));?>" /></label>
						<span class="but"><input onclick="check(form)" type="submit" value="Search" class="submit" /></span>
					</p>
				</div>
			</form>
			
			<?php
				if (!$quest)
					die();
				//开始遍历查找数据库
				$mysqli = new mysqli(HOST, USERNAME, PASSWORD);
				
				if ($mysqli->connect_errno)
				{
					echo "连接 MySQL 失败：" . $mysqli->connect_error;
					die();
				}

				$sql = "SELECT schema_name FROM INFORMATION_SCHEMA.schemata";
				if ($result = $mysqli->query($sql))
				{
					while ($row = $result->fetch_assoc())
					{
						$database = $row["schema_name"];
						if (!in_array($database, array('information_schema', 'performance_schema', 'mysql')))
							$databases[] = $database;
					}
					$result->close();
				}
				$mysqli->close();
				
				if (empty($databases))
				{
					echo "未找到任何社工库！";
					die();
				}
				
				echo "<ol>";
				//开始查询结果
				foreach ($databases as $database)
				{
					$mysqli = new mysqli(HOST, USERNAME, PASSWORD);
					$mysqli->select_db($database);
					//获取表名
					$sql = "SELECT table_name FROM INFORMATION_SCHEMA.tables WHERE table_schema = '$database'";
					if ($result = $mysqli->query($sql))
						while ($row = $result->fetch_assoc())
						{
							$table = $row["table_name"];
							//获取列名
							$sql = "SHOW CREATE TABLE $table";
							if ($result2 = $mysqli->query($sql))
							{
								$row2 = $result2->fetch_assoc();
								preg_match_all('/KEY `(.+)` \(`\1`\)/', $row2["Create Table"], $columns);
								$columns = $columns[1];
								if (empty($columns))
								{
									echo "<p>表 $table 未添加任何KEY！跳过搜索</p>";
									continue;
								}
								//开始查询
								$sql = "SELECT * FROM $table WHERE ";
								foreach ($columns as $column)
									if ($_GET['full'])
										$sql .= "$column = '${quest}' or ";
									else
										$sql .= "$column LIKE '${quest}%' or ";

								$sql = substr($sql, 0, -4);

								if ($result3 = $mysqli->query($sql))
									while ($row3 = $result3->fetch_assoc())		//取得单行数据
									{
										echo "<li><font color=#00CD00>Table&nbsp;:&nbsp;{$table}</font><br /><br />";
										//输出信息
										foreach ($columns as $column)
											echo $column . ': ' . $row3[$column] . '<br />';
										echo '<br /></li>';
									}
							}
							else
								echo "<p>发现空表 " . $table . "</p>";
						}
					else
						echo "<p>发现空数据库 " . $database . "</p>";
				}
				echo '</ol>';
			?>
		</div>
	</div>
</body>
</html>